version: "3"

tasks:
  init:ci:
    desc: Initialize CI environment
    cmds:
      - pip install libs/arduino_app_bricks-0.4.8-py3-none-any.whl reuse pip-licenses

  license:
    deps:
      - init:ci
    desc: Update license headers and files
    cmds:
      - |
        git ls-files |
        grep -Ev "(^|/)(libs|sketch-libraries|assets)/|THIRD-PARTY-LICENSES.json|\.(md|txt|yml|yaml|toml|gitignore|gitmodules)$" |
        sed 's/ /\\ /g' |
        xargs reuse annotate -r --skip-unrecognized --copyright-prefix 'spdx-string-c' --copyright 'ARDUINO SRL (http://www.arduino.cc)' --exclude-year --license 'MPL-2.0'
      - reuse download --all
      - |
        licenses_dir="LICENSES"
        if [ -d "$licenses_dir" ]; then
          count=$(find "$licenses_dir" -type f | wc -l)
          if [ "$count" -gt 1 ]; then
            for f in "$licenses_dir"/*; do
              base=$(basename "$f")
              mv "$f" "LICENSE-${base}"
            done
          elif [ "$count" -eq 1 ]; then
            f=$(find "$licenses_dir" -type f | head -n1)
            mv "$f" LICENSE.txt
          fi
          rmdir "$licenses_dir"
        fi
      - pip-licenses --format=json --output-file=THIRD-PARTY-LICENSES.json

  # Source: https://github.com/arduino/tooling-project-assets/blob/main/workflow-templates/assets/check-markdown-task/Taskfile.yml
  markdown:check-links:
    desc: Check for broken links
    vars:
      # The command is defined in a Taskfile variable to allow it to be broken into multiple lines for readability.
      # This can't be done in the `cmd` object of the Taskfile because `npx --call` uses the native shell, which causes
      # standard newline escaping syntax to not work when the task is run on Windows.
      #
      # Using -regex instead of -name to avoid Task's behavior of globbing even when quoted on Windows
      # The odd method for escaping . in the regex is required for windows compatibility because mvdan.cc/sh gives
      # \ characters special treatment on Windows in an attempt to support them as path separators.
      #
      # prettier-ignore
      CHECK_LINKS_COMMAND:
        "
          find . \
            -type d -name \".git\" -prune -o \
            -type d -name \".licenses\" -prune -o \
            -type d -name \"__pycache__\" -prune -o \
            -type d -name \"node_modules\" -prune -o \
            -regex \".*[.]md\" \
            -exec \
              markdown-link-check \
                --quiet \
                --config \"./.markdown-link-check.json\" \
                \\{\\} \
                +
        "
    cmds:
      - |
        npx \
          --package=markdown-link-check \
          --call='{{.CHECK_LINKS_COMMAND}}'
